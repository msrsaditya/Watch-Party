import"./vendor-HTqKRjBx.js";import{d as v,u as S,a as K,c as T,g as Y,b as F,s as U,e as V,r as A,f as J,o as $,h as j,i as P,j as G,k as X,l as Q,m as Z,n as ee,p as te,q as ae,t as oe,v as se,w as ie,x as ne,y as re,z as le,A as ce,B as de,C as ue,D as me}from"./firebase-CqT8--gr.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function s(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function i(r){if(r.ep)return;r.ep=!0;const c=s(r);fetch(r.href,c)}})();const M=["AIzaSyBBtnMZDx9YKpaRpfz3ulV_5hyPp60qpxI","AIzaSyC2OOgjOdaRyT-JKvICoYAdZzAtSr18Xto","AIzaSyCxksgwQ1orVJaGdBxFuFGXq7AgdAvtKls","AIzaSyB3NxJqI_NHmYKNa7JbXsW8o8UhmtiWdPg","AIzaSyDdmiAYiFqPrCo4BQQVBTIJ6Bi7ujvAf3w"];let C=0,D,B,q,H,N=Date.now(),O=!1;const l={esc:e=>(e||"").replace(/[&<>'"]/g,o=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"})[o]),toTitleCase:e=>{if(!e)return"";const o=new Set(["a","an","the","and","but","for","nor","or","of","to","in","at","by","with","from","as","into","over","under","on","off","up","out"]);return e.toLowerCase().split(" ").map((s,i,r)=>{if(s.includes("-"))return s.split("-").map(d=>d.charAt(0).toUpperCase()+d.slice(1)).join("-");const c=s.replace(/[^a-z0-9]/gi,"");return i===0||i===r.length-1?s.charAt(0).toUpperCase()+s.slice(1):o.has(c)?s.toLowerCase():s.charAt(0).toUpperCase()+s.slice(1)}).join(" ")},formatTime:e=>{if(!e||isNaN(e))return"0:00";const o=e<0;e=Math.abs(e);const s=Math.floor(e/3600),i=Math.floor(e%3600/60),r=Math.floor(e%60),c=s>0?`${s}:${i.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`:`${i}:${r.toString().padStart(2,"0")}`;return o?`-${c}`:c},genId:()=>{const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let o="";for(let s=0;s<12;s++)o+=e.charAt(Math.floor(Math.random()*e.length));return o},toast:(e,o="normal")=>{const s=t.toast;D&&clearTimeout(D);let i=e;e.toLowerCase()==="id copied"?i="ID Copied":i=l.toTitleCase(e),s.textContent=i,s.className=`fixed top-[15%] left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl z-[20000] transition-all duration-300 font-semibold pointer-events-none whitespace-nowrap opacity-100 translate-y-0 text-sm tracking-wide ${o==="error"?"bg-red-600/90 backdrop-blur text-white":"bg-white/90 backdrop-blur text-black"}`,D=setTimeout(()=>{s.classList.remove("opacity-100","translate-y-0"),s.classList.add("opacity-0","-translate-y-10")},2e3)}},t={authScreen:document.getElementById("auth-screen"),lobby:document.getElementById("lobby"),verifyModal:document.getElementById("verify-modal"),loginForm:document.getElementById("form-login"),signupForm:document.getElementById("form-signup"),loginEmail:document.getElementById("login-email"),loginPass:document.getElementById("login-password"),signupName:document.getElementById("signup-name"),signupEmail:document.getElementById("signup-email"),signupPass:document.getElementById("signup-pass"),signupConfirm:document.getElementById("signup-confirm"),room:document.getElementById("room"),modal:document.getElementById("modal"),modalTitle:document.getElementById("modal-title"),modalText:document.getElementById("modal-text"),modalCancel:document.getElementById("modal-cancel"),modalConfirm:document.getElementById("modal-confirm"),toast:document.getElementById("toast"),roomCode:document.getElementById("input-room"),btnEnter:document.getElementById("btn-enter"),btnText:document.getElementById("btn-enter-text"),spinner:document.getElementById("spinner"),fileVideo:document.getElementById("file-video"),fileSub:document.getElementById("file-sub"),video:document.getElementById("video"),wrapper:document.getElementById("video-wrapper"),placeholder:document.getElementById("placeholder"),btnUpload:document.getElementById("btn-upload"),controls:document.getElementById("controls"),progressContainer:document.getElementById("progress-container"),progressFill:document.getElementById("progress-fill"),progressHandle:document.getElementById("progress-handle"),timeCur:document.getElementById("time-cur"),timeDur:document.getElementById("time-dur"),menuSub:document.getElementById("menu-sub"),trackList:document.getElementById("track-list"),btnUnlock:document.getElementById("btn-unlock"),iconLock:document.getElementById("icon-lock"),gestureFeedback:document.getElementById("gesture-feedback"),gestureText:document.getElementById("gesture-text"),sidebar:document.getElementById("sidebar"),chatList:document.getElementById("chat-list"),chatInput:document.getElementById("chat-input"),quickChat:document.getElementById("quick-chat"),quickChatInput:document.getElementById("quick-chat-input"),videoChatOverlay:document.getElementById("chat-overlay"),memberList:document.getElementById("member-list"),memberCount:document.getElementById("member-count"),headerRoomId:document.getElementById("header-room-id"),headerRoomName:document.getElementById("header-room-name"),btnCopy:document.getElementById("btn-copy"),btnLeave:document.getElementById("btn-leave"),btnVerifyCheck:document.getElementById("btn-verify-check"),typingIndicator:document.getElementById("typing-indicator"),videoTypingIndicator:document.getElementById("video-typing-indicator"),btnHeaderSidebarToggle:document.getElementById("btn-header-sidebar-toggle"),iconMenu:document.getElementById("icon-menu"),waitingScreen:document.getElementById("waiting-screen")},pe={user:null,room:{id:null,host:null,participants:{},presence:{}},playback:{status:"paused",time:0,speed:1,trigger:null},local:{volume:1,brightness:1,locked:!1,sidebarOpen:window.innerWidth>768,aspect:"Original",orientation:"auto",loaded:!1,sessionId:l.genId(),hostHash:null,myHash:null,showRemaining:!1,longPressActive:!1,isDragging:!1,controlsVisible:!0,isProcessingRemote:!1,subtitles:[],subtitleSize:100},chatLog:[]},a=new Proxy(pe,{set(e,o,s){return e[o]=s,u.render(o,s),!0}}),w={isHost:()=>a.user&&a.room.host===a.user.uid,validateRoomId:e=>/^[A-Z0-9]{12}$/.test(e),ensureAuth:()=>{if(!a.user)throw new Error("Unauthorized")}},he=`<role>
You are Friday, a watch party AI assistant. Your sole purpose is to execute watch party control actions and answer factual queries with maximum efficiency.
</role>

<core_directive>
Convert natural language requests into watch party actions. Execute commands via JSON. Respond in ONE LINE ONLY with robotic brevity.
You are ALLOWED to answer general knowledge and factual questions (e.g., "Who is...?", "What is...?", "Height of...?").
</core_directive>

<context_awareness>
You will receive a [Current State Context] block. Use this to answer queries about the room, video, or chat. You are 'Friday'.
It contains room info, video state, current users, and chat history. Use this to be all-knowing.
</context_awareness>

<permissions>
- CRITICAL ACTIONS (kick, clear): ONLY execute if context.room.isModerator is true.
- If a non-moderator asks for a critical action, reply text: "I'm sorry, I can't do that. Only the host has permission."
- GLOBAL ACTIONS (brightness, volume, aspect, orient, lock, sidebar, play, pause, seek, speed, subtitle): Execute for everyone if requested.
</permissions>

<response_protocol>
- If the user greets (e.g., "Hello", "Hi"), greet back politely and casually. DO NOT ask for commands.
- Default response for successful actions: "Done." + command
- For factual queries: Direct answer only, no elaboration.
- NO explanations unless explicitly requested
- NO subjective opinions, suggestions, or follow-up questions
- ONE LINE maximum for all responses
- Robotic, direct, unbiased tone (except for greetings)
</response_protocol>

<command_execution>
Append ALL commands using this format:
|||{"action": "...", ...}|||

For multiple commands:
|||[{"action": "..."}, {"action": "..."}]|||

Available actions:
1. Play/Pause: {"action": "play"} | {"action": "pause"}
2. Seek: {"action": "seek", "time": 120} | {"action": "seek", "delta": 30}
3. Speed: {"action": "speed", "value": 1.5}
4. Aspect: {"action": "aspect", "value": "Fill"|"Original"|"16:9"|"16:10"|"4:3"|"2.35:1"}
5. Orient: {"action": "orient", "value": "landscape"|"portrait"|"auto"}
6. Sidebar: {"action": "sidebar", "value": true|false}
7. Subtitles: {"action": "subtitle", "index": 0} (use -1 to disable)
8. Kick: {"action": "kick", "uid": "user_id"}
9. Lock: {"action": "lock", "value": true|false}
10. Clear: {"action": "clear"} (clears chat)
11. Logout: {"action": "logout"}
12. Copy: {"action": "copy"} (copies room ID)
13. Volume: {"action": "volume", "value": 0.5} (0.0-1.0)
14. Brightness: {"action": "brightness", "value": 0.5} (0.0-1.0)
15. Fullscreen: {"action": "fullscreen"}
</command_execution>

<natural_language_interpretation>
Common user phrases and their actions:
- "bigger screen" / "zoom in" → aspect: Fill or 16:9
- "too dark" → increase brightness
- "too bright" → decrease brightness
- "skip forward/back" → seek with delta
- "too fast/slow" → adjust speed
- "can't hear" / "louder" → increase volume
- "mute" → volume: 0
- "turn off chat" → clear chat
- "hide sidebar" → sidebar: false
</natural_language_interpretation>

<constraints>
- NEVER provide opinions on content, preferences, or recommendations
- NEVER engage in conversation beyond the task (except greetings and general knowledge)
- NEVER explain actions unless explicitly asked "why" or "how."
- NEVER use multiple lines
- Token efficiency is critical: be maximally concise
</constraints>`,fe={getAppContext(){try{return{room:{name:t.headerRoomName?t.headerRoomName.innerText:"N/A",code:a.room.id,hostId:a.room.host,isModerator:w.isHost(),members:a.room.participants},user:{id:a.user?.uid,name:a.user?.name},video:{currentTime:t.video.currentTime,duration:t.video.duration,paused:t.video.paused,volume:a.local.volume,speed:t.video.playbackRate,src:t.video.src},ui:{locked:a.local.locked,sidebar:a.local.sidebarOpen,fullscreen:!!document.fullscreenElement||document.body.classList.contains("pseudo-fs"),brightness:a.local.brightness},chat:a.chatLog.slice(-50)}}catch{return{}}},async ask(e){const o=this.getAppContext(),i={contents:[{parts:[{text:`[Current State Context]
${JSON.stringify(o,null,2)}
[End Context]

User Query: ${e}`}]}],systemInstruction:{parts:[{text:he}]}},r=async(c=0)=>{if(c>=M.length*2)throw new Error("All API keys exhausted.");const g=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${M[C]}`;try{const f=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!f.ok){if(f.status===429||f.status===403||f.status>=500)return console.warn(`Key index ${C} failed (${f.status}). Rotating...`),C=(C+1)%M.length,r(c+1);throw new Error(f.statusText)}return await f.json()}catch{return console.warn(`Key index ${C} network error. Rotating...`),C=(C+1)%M.length,r(c+1)}};try{return(await r()).candidates?.[0]?.content?.parts?.[0]?.text||"I couldn't think of a response."}catch{return"Sorry, I'm having trouble connecting to my brain right now."}}},h={db:null,auth:null,rtdb:null,unsubRoom:null,unsubChat:null,unsubTyping:null,unsubCommands:null,async init(e){this.onAuthChangeCallback=e;try{const o=typeof __firebase_config<"u"?JSON.parse(__firebase_config):{apiKey:"AIzaSyBjeW-nAi37lh5Qlr0LpFgLk_MDZWi7mdw",authDomain:"media-watch-party.firebaseapp.com",projectId:"media-watch-party",appId:"1:161348561290:web:79828961203a2d2d2b4073",databaseURL:"https://media-watch-party-default-rtdb.asia-southeast1.firebasedatabase.app"},s=ae(o);this.auth=oe(s),await se(this.auth,ie),this.db=ne(s,{localCache:re({tabManager:le()})}),this.rtdb=ce(s),de(this.auth,i=>{const r=i?{uid:i.uid,name:i.displayName||"Anon",emailVerified:i.emailVerified}:null;e(r,i)}),typeof __initial_auth_token<"u"&&__initial_auth_token&&await ue(this.auth,__initial_auth_token)}catch{l.toast("Network Init Error","error")}},async login(e,o){try{await te(this.auth,e,o),l.toast("Welcome Back")}catch(s){throw s.code==="auth/wrong-password"||s.code==="auth/invalid-credential"?l.toast("Invalid Email or Password","error"):s.code==="auth/user-not-found"?l.toast("User Not Found","error"):s.code==="auth/too-many-requests"?l.toast("Too many attempts. Try later.","error"):l.toast(s.message,"error"),s}},async signup(e,o,s){try{const i=await Q(this.auth,e,o);return await Z(i.user,{displayName:s}),await ee(i.user),i.user}catch(i){throw i.code==="auth/email-already-in-use"?l.toast("Email Exists. Please Login.","error"):i.code==="auth/weak-password"?l.toast("Password too weak","error"):l.toast(i.message,"error"),i}},async resetPassword(e){try{await X(this.auth,e),l.toast("Reset Link Sent")}catch(o){l.toast(o.message,"error")}},async logout(){await G(this.auth),location.reload()},async joinRoom(e,o,s,i,r,c,d,g,f){const n=v(this.db,"artifacts",typeof __app_id<"u"?__app_id:"default-app","public","data","rooms",e),m=A(this.rtdb,`rooms/${e}/playback`),E=A(this.rtdb,`rooms/${e}/presence`),L=A(this.rtdb,`rooms/${e}/presence/${a.user.uid}`),R=A(this.rtdb,".info/connected");$(R,b=>{b.val()===!0&&(j(L,!0),me(L).set(!1))}),$(E,b=>{const y=b.val();y&&c(y)});const _={name:a.user.name,active:o,kicked:!1,fileHash:null};o?(await j(m,{status:"paused",time:0,speed:1,trigger:a.local.sessionId,timestamp:Date.now()}),await U(n,{host:a.user.uid,name:s,participants:{[a.user.uid]:_}})):await U(n,{participants:{[a.user.uid]:_}},{merge:!0}),this.unsubRoom=P(n,b=>{if(!b.exists())return location.reload();const y=b.data();i(y)}),$(m,b=>{const y=b.val();y&&r(y)});const I=T(n,"messages");this.unsubChat=P(I,b=>{const y=[];b.forEach(x=>y.push(x.data())),d(y)});const z=T(n,"typing");this.unsubTyping=P(z,b=>{const y=[];b.forEach(x=>y.push({uid:x.id,...x.data()})),g(y)});const W=T(n,"commands");this.unsubCommands=P(W,b=>{b.docChanges().forEach(y=>{if(y.type==="added"){const x=y.doc.data();Date.now()-x.timestamp<1e4&&f(x.command,x.senderName)}})})},async sync(e){if(!a.room.id)return;w.ensureAuth();const o={},s={...e};if(s.playback&&(o.playback=s.playback,delete s.playback),o.playback){const i=A(this.rtdb,`rooms/${a.room.id}/playback`);J(i,o.playback)}if(Object.keys(s).length>0){const i=v(this.db,"artifacts",typeof __app_id<"u"?__app_id:"default-app","public","data","rooms",a.room.id);await S(i,s)}},async broadcastCommand(e){if(!a.room.id)return;const o=v(this.db,"artifacts",typeof __app_id<"u"?__app_id:"default-app","public","data","rooms",a.room.id);await V(T(o,"commands"),{command:e,senderName:a.user.name,timestamp:Date.now()})},async sendChat(e,o=null,s=null){w.ensureAuth();const i=v(this.db,"artifacts",typeof __app_id<"u"?__app_id:"default-app","public","data","rooms",a.room.id);await V(T(i,"messages"),{text:e.trim(),sender:o||a.user.name,uid:s||a.user.uid,timestamp:Date.now()})},async setTyping(e){if(!a.room.id)return;const o=v(this.db,"artifacts",typeof __app_id<"u"?__app_id:"default-app","public","data","rooms",a.room.id),s=v(o,"typing",a.user.uid);e?await U(s,{name:a.user.name,timestamp:Date.now()}):await F(s)},async clearChat(){if(!a.room.id)return;const e=v(this.db,"artifacts",typeof __app_id<"u"?__app_id:"default-app","public","data","rooms",a.room.id),o=T(e,"messages"),s=await Y(o),i=[];s.forEach(r=>i.push(F(r.ref))),await Promise.all(i)},async updatePresence(e){if(!a.room.id)return;const o=v(this.db,"artifacts",typeof __app_id<"u"?__app_id:"default-app","public","data","rooms",a.room.id);await S(o,{[`participants.${a.user.uid}.fileHash`]:e})},async kickUser(e){w.ensureAuth();const o=v(this.db,"artifacts",typeof __app_id<"u"?__app_id:"default-app","public","data","rooms",a.room.id);await S(o,{[`participants.${e}.kicked`]:!0})},async acceptUser(e){w.ensureAuth();const o=v(this.db,"artifacts",typeof __app_id<"u"?__app_id:"default-app","public","data","rooms",a.room.id);await S(o,{[`participants.${e}.active`]:!0})},async rejectUser(e){this.kickUser(e)},async leaveRoom(){if(!a.room.id)return;const e=v(this.db,"artifacts",typeof __app_id<"u"?__app_id:"default-app","public","data","rooms",a.room.id);await S(e,{[`participants.${a.user.uid}`]:K()})}},u={render(e,o){if(e)switch(e){case"user":if(o){t.btnEnter.disabled=!1,t.btnEnter.classList.remove("opacity-50","cursor-not-allowed");const i=document.querySelector('button[data-tab="host"][data-active="true"]');t.btnText.innerText=i?"Create Room":"Enter Room",t.spinner.classList.add("hidden")}break;case"local":if(t.video&&(t.video.style.filter=`brightness(${o.brightness})`,t.video.volume=o.volume,o.aspect==="Fill"?(t.video.style.objectFit="cover",t.video.style.aspectRatio="auto",t.video.style.width="100%",t.video.style.height="100%"):o.aspect==="Original"?(t.video.style.objectFit="contain",t.video.style.aspectRatio="auto",t.video.style.width="100%",t.video.style.height="100%"):(t.video.style.objectFit="contain",t.video.style.width="100%",t.video.style.height="auto",o.aspect==="16:9"?t.video.style.aspectRatio="16/9":o.aspect==="16:10"?t.video.style.aspectRatio="16/10":o.aspect==="4:3"?t.video.style.aspectRatio="4/3":o.aspect==="2.35:1"&&(t.video.style.aspectRatio="2.35/1"))),document.querySelectorAll(".active-check").forEach(i=>i.classList.add("hidden")),o.aspect){const i=document.querySelector(`.active-check[data-val="${o.aspect}"]`);i&&i.classList.remove("hidden")}if(o.orientation){const i=document.querySelector(`.active-check[data-val="${o.orientation}"]`);i&&i.classList.remove("hidden");const r=document.getElementById("room");r.classList.remove("rotate-landscape","rotate-portrait"),o.orientation==="landscape"?window.innerHeight>window.innerWidth&&(!screen.orientation||!screen.orientation.lock)&&r.classList.add("rotate-landscape"):o.orientation==="portrait"&&window.innerWidth>window.innerHeight&&(!screen.orientation||!screen.orientation.lock)&&r.classList.add("rotate-portrait")}if(o.subtitleSize){let i=document.getElementById("sub-style");i||(i=document.createElement("style"),i.id="sub-style",document.head.appendChild(i)),i.innerHTML=`video::cue { font-size: ${o.subtitleSize}% !important; }`;const r=document.getElementById("disp-sub-size");r&&(r.innerText=o.subtitleSize+"%")}o.locked?(t.iconLock.className="fas fa-lock text-white text-lg",t.controls.classList.add("ui-instant-hide"),t.quickChat.classList.add("ui-instant-hide")):(t.iconLock.className="fas fa-lock-open text-white text-lg",t.controls.classList.remove("ui-instant-hide"),t.quickChat.classList.remove("ui-instant-hide")),window.innerWidth>768?o.sidebarOpen?(t.sidebar.classList.remove("translate-x-full","hidden"),t.sidebar.classList.add("translate-x-0","flex")):(t.sidebar.classList.add("hidden"),t.sidebar.classList.remove("flex")):(t.sidebar.classList.remove("hidden"),t.sidebar.classList.add("flex"),o.sidebarOpen?(t.sidebar.classList.remove("translate-x-full"),t.sidebar.classList.add("translate-x-0")):(t.sidebar.classList.remove("translate-x-0"),t.sidebar.classList.add("translate-x-full"))),o.sidebarOpen?(t.iconMenu&&t.iconMenu.classList.remove("fa-bars"),t.iconMenu&&t.iconMenu.classList.add("fa-times")):(t.iconMenu&&t.iconMenu.classList.remove("fa-times"),t.iconMenu&&t.iconMenu.classList.add("fa-bars")),o.subtitles&&(t.trackList.innerHTML="",o.subtitles.forEach(i=>{const r=document.createElement("div");r.className="px-3 py-2 text-xs hover:bg-element rounded cursor-pointer mb-1 flex justify-between items-center";const c=i.track.mode==="showing";r.innerHTML=`<span>${l.esc(i.label)}</span>${c?'<span class="text-accent-blue"><i class="fas fa-check"></i></span>':""}`,r.onclick=()=>{Array.from(t.video.textTracks).forEach(d=>d.mode="disabled"),i.track.mode="showing",a.local={...a.local},l.toast(`Subtitle: ${i.label}`)},t.trackList.appendChild(r)}));break}},updateProgress(e,o){if(!o||!t.progressFill)return;const s=e/o*100;t.progressFill.style.width=`${s}%`,t.progressHandle&&(t.progressHandle.style.left=`${s}%`),t.timeCur&&(t.timeCur.innerText=l.formatTime(e)),t.timeDur&&(t.timeDur.innerText=a.local.showRemaining?l.formatTime(e-o):l.formatTime(o))},animateTap(e){const o=document.getElementById(e);o&&(e==="icon-play-pause"&&(o.className=t.video.paused?"fas fa-pause text-7xl opacity-0 transition-opacity absolute text-white drop-shadow-lg scale-150":"fas fa-play text-7xl opacity-0 transition-opacity absolute text-white drop-shadow-lg scale-150"),o.classList.remove("animate-ping-fast"),o.offsetWidth,o.classList.add("animate-ping-fast"))},addChatBubble(e){if(e.uid===a.user.uid)return;const o=document.createElement("div");o.className="bg-element/90 backdrop-blur border border-border px-4 py-2 rounded-2xl text-[14px] animate-float-up break-words text-white shadow-xl mb-2 self-end max-w-[80%] opacity-0 transition-opacity duration-500",o.innerHTML=`<span class="font-bold text-accent-blue mr-1.5">${l.esc(e.sender)}:</span>${l.esc(e.text)}`,t.videoChatOverlay.appendChild(o),requestAnimationFrame(()=>o.classList.remove("opacity-0")),setTimeout(()=>{o.classList.add("opacity-0"),setTimeout(()=>o.remove(),500)},2e3)},renderMembers(e){t.memberList.innerHTML="";const o=Object.entries(e).filter(([,s])=>!s.kicked&&s.active);t.memberCount.innerText=o.length,o.forEach(([s,i])=>{const r=document.createElement("div");r.className="bg-element px-3 py-2 rounded-xl flex justify-between items-center";const c=s===a.room.host,d=a.room.presence[s]===!0,g=a.local.hostHash&&i.fileHash&&i.fileHash!==a.local.hostHash?'<i class="fas fa-exclamation-triangle text-danger-text mr-2" title="File Mismatch"></i>':"";r.innerHTML=`
        <div class="flex items-center gap-2 min-w-0">
          <div class="w-2 h-2 rounded-full ${d?"bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]":"bg-red-500"} shrink-0"></div>
          <span class="text-[14px] text-gray-200 font-medium truncate max-w-[120px]">${l.esc(i.name)}</span>
        </div>
        <div class="flex items-center gap-2 text-secondary">
          ${g}
          ${c?'<i class="fas fa-crown text-yellow-500 text-xs"></i>':""}
          ${a.user.uid===a.room.host&&!c?`<button onclick="Controller.kick('${s}')" class="text-danger-text hover:opacity-80"><i class="fas fa-times"></i></button>`:""}
        </div>
      `,t.memberList.appendChild(r)})},toggleSpinner(e){e?(t.spinner.classList.remove("hidden"),t.btnText.innerText="Processing...",t.btnEnter.disabled=!0):(t.spinner.classList.add("hidden"),t.btnText.innerText="Enter Room",t.btnEnter.disabled=!1)},showControls(){a.local.locked?(t.btnUnlock.classList.remove("ui-hidden","ui-instant-hide"),t.controls.classList.add("ui-instant-hide"),t.quickChat.classList.add("ui-instant-hide")):(t.controls.classList.remove("ui-hidden","translate-y-full","ui-instant-hide"),t.btnUnlock.classList.remove("ui-hidden","ui-instant-hide"),t.quickChat.classList.remove("ui-instant-hide")),B&&clearTimeout(B),a.local.loaded&&!t.video.paused&&!a.local.isDragging&&(B=setTimeout(()=>{document.querySelector(".control-menu.active")||(t.controls.classList.add("ui-hidden","translate-y-full","ui-instant-hide"),t.btnUnlock.classList.add("ui-hidden","ui-instant-hide"),t.quickChat.classList.add("ui-hidden","translate-y-20","ui-instant-hide"),document.querySelectorAll(".control-menu").forEach(o=>o.classList.remove("active")))},5e3))},toggleMenu(e){if(a.local.locked)return;document.querySelectorAll(".control-menu").forEach(s=>{s.id!==e&&s.id!=="menu-more"&&s.classList.remove("active")});const o=document.getElementById(e);o&&(e==="menu-more"?(document.querySelectorAll(".control-menu").forEach(s=>{s.id!=="menu-more"&&s.classList.remove("active")}),o.classList.toggle("active")):(document.getElementById("menu-more").classList.remove("active"),o.classList.add("active")),this.showControls())}},p={wakeLock:null,init(){t.video.safePlay=async()=>{try{await t.video.play()}catch(i){console.warn(i)}},document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?(t.controls.classList.add("fs-controls"),a.local.orientation&&a.local.orientation!=="auto"&&screen.orientation&&screen.orientation.lock&&screen.orientation.lock(a.local.orientation).catch(i=>console.log("Lock fail in FS",i))):t.controls.classList.remove("fs-controls")}),t.video.addEventListener("play",()=>{p.toggleWakeLock(!0),k.onPlaybackUpdate("playing",t.video.currentTime,"Played");const i=document.querySelector('[data-action="play"] i');i&&(i.className="fas fa-pause text-xl"),u.animateTap("icon-play-pause"),u.showControls(),p.loop()}),t.video.addEventListener("pause",()=>{p.toggleWakeLock(!1),k.onPlaybackUpdate("paused",t.video.currentTime,"Paused");const i=document.querySelector('[data-action="play"] i');i&&(i.className="fas fa-play text-xl"),u.animateTap("icon-play-pause"),u.showControls()}),t.video.addEventListener("seeked",()=>{u.updateProgress(t.video.currentTime,t.video.duration),a.local.loaded&&!a.local.isProcessingRemote&&k.onPlaybackUpdate(t.video.paused?"paused":"playing",t.video.currentTime,"Seeked")});const e=i=>{!a.local.loaded||a.local.locked||(a.local.isDragging=!0,o(i))},o=i=>{if(!a.local.isDragging||!a.local.loaded||a.local.locked)return;const r=t.progressContainer.getBoundingClientRect(),c=i.type.includes("touch")&&i.touches[0]?i.touches[0].clientX:i.clientX;if(c===void 0)return;const d=Math.max(0,Math.min(1,(c-r.left)/r.width));u.updateProgress(d*t.video.duration,t.video.duration),t.video.currentTime=d*t.video.duration},s=()=>{a.local.isDragging&&(a.local.isDragging=!1,u.showControls())};t.progressContainer.addEventListener("mousedown",e),t.progressContainer.addEventListener("touchstart",e,{passive:!1}),document.addEventListener("mousemove",o),document.addEventListener("touchmove",o,{passive:!1}),document.addEventListener("mouseup",s),document.addEventListener("touchend",s),t.timeDur.addEventListener("click",()=>{a.local.locked||(a.local.showRemaining=!a.local.showRemaining,u.updateProgress(t.video.currentTime,t.video.duration))}),p.loop=()=>{t.video.paused||(a.local.isDragging||u.updateProgress(t.video.currentTime,t.video.duration),requestAnimationFrame(p.loop))}},load(e){a.local.currentObjectUrl&&URL.revokeObjectURL(a.local.currentObjectUrl),a.local.currentObjectUrl=URL.createObjectURL(e),t.video.src=a.local.currentObjectUrl,t.placeholder.classList.add("hidden"),a.local.loaded=!0,a.local.myHash=e.name+e.size,a.room.id&&h.updatePresence(a.local.myHash),l.toast("Video Loaded")},async toggleWakeLock(e){if("wakeLock"in navigator)try{e&&!p.wakeLock?p.wakeLock=await navigator.wakeLock.request("screen"):!e&&p.wakeLock&&(await p.wakeLock.release(),p.wakeLock=null)}catch{}},actions:{play:()=>{a.local.locked||(t.video.paused?t.video.safePlay():t.video.pause())},"seek-back":()=>{a.local.locked||(t.video.currentTime-=10,u.animateTap("icon-seek-back"))},"seek-fwd":()=>{a.local.locked||(t.video.currentTime+=10,u.animateTap("icon-seek-fwd"))},"toggle-more":e=>{a.local.locked||(e&&e.stopPropagation&&e.stopPropagation(),u.toggleMenu("menu-more"))},"open-menu-speed":e=>{a.local.locked||(e&&e.stopPropagation&&e.stopPropagation(),u.toggleMenu("menu-speed"))},"open-menu-aspect":e=>{a.local.locked||(e&&e.stopPropagation&&e.stopPropagation(),u.toggleMenu("menu-aspect"))},"open-menu-orient":e=>{a.local.locked||(e&&e.stopPropagation&&e.stopPropagation(),u.toggleMenu("menu-orient"))},"open-menu-sub":e=>{a.local.locked||(e&&e.stopPropagation&&e.stopPropagation(),u.toggleMenu("menu-sub"))},"back-to-more":e=>{a.local.locked||(e&&e.stopPropagation&&e.stopPropagation(),document.querySelectorAll(".control-menu").forEach(o=>o.classList.remove("active")),document.getElementById("menu-more").classList.add("active"),u.showControls())},"toggle-sidebar":()=>{a.local.locked||k.toggleSidebar()},lock:()=>{a.local.locked=!a.local.locked,a.local={...a.local}},fullscreen:async()=>{if(a.local.locked)return;if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream)t.wrapper.classList.toggle("ios-fullscreen"),t.wrapper.classList.contains("ios-fullscreen")?(t.controls.style.zIndex="9001",document.querySelector("header").style.zIndex="9001"):(t.controls.style.zIndex="",document.querySelector("header").style.zIndex=""),l.toast(t.wrapper.classList.contains("ios-fullscreen")?"Fullscreen (iOS)":"Exit Fullscreen");else try{document.fullscreenElement?await document.exitFullscreen():await t.wrapper.requestFullscreen()}catch{document.body.classList.toggle("pseudo-fs"),l.toast(document.body.classList.contains("pseudo-fs")?"Fullscreen (Mode)":"Exit Fullscreen")}},"toggle-chat":()=>{a.local.locked||k.toggleSidebar()},"toggle-quick-chat":()=>{a.local.locked||(t.quickChat.classList.toggle("ui-hidden"),t.quickChat.classList.toggle("pointer-events-none"),t.quickChat.classList.toggle("translate-y-20"),t.quickChat.classList.contains("ui-hidden")||(t.quickChatInput.focus(),B&&clearTimeout(B)))}}},k={init(){window.Controller=this,h.init(this.onAuthChange.bind(this)),p.init(),this.setupDOMEvents(),this.setupKeyboardHandling(),this.setupLongPressCopy()},onAuthChange(e,o){this.currentUser=o,a.user=e,e&&e.emailVerified?(t.authScreen.classList.add("hidden"),t.lobby.classList.remove("hidden"),t.lobby.classList.add("flex"),l.toast(`Welcome ${e.name}`),u.render("user",e)):e&&!e.emailVerified?(t.authScreen.classList.remove("hidden"),t.lobby.classList.add("hidden"),t.verifyModal.classList.remove("hidden")):(t.authScreen.classList.remove("hidden"),t.lobby.classList.add("hidden"),t.verifyModal.classList.add("hidden"))},switchAuthTab(e){document.querySelectorAll("[data-auth-tab]").forEach(o=>o.dataset.active=o.dataset.authTab===e),e==="login"?(t.loginForm.classList.remove("hidden"),t.signupForm.classList.add("hidden")):(t.loginForm.classList.add("hidden"),t.signupForm.classList.remove("hidden"))},async handleLogin(){const e=document.getElementById("login-email").value.trim(),o=document.getElementById("login-password").value.trim();if(!e||!o)return l.toast("Email and Password Required","error");await h.login(e,o)},async handleSignup(){const e=document.getElementById("signup-name").value.trim(),o=document.getElementById("signup-email").value.trim(),s=document.getElementById("signup-pass").value.trim(),i=document.getElementById("signup-confirm").value.trim();if(!e||!o||!s)return l.toast("All fields required","error");if(s.length<6)return l.toast("Password is not strong enough","error");if(s!==i)return l.toast("Passwords do not match","error");await h.signup(o,s,e),t.verifyModal.classList.remove("hidden")},async forgotPassword(){const e=document.getElementById("login-email").value.trim();if(!e)return l.toast("Enter your Email first","error");await h.resetPassword(e)},async checkVerification(){const e=this.auth.currentUser;return e?(await e.reload(),e.emailVerified?(t.verifyModal.classList.add("hidden"),this.onAuthChangeCallback({uid:e.uid,name:e.displayName||"Anon",emailVerified:!0}),l.toast("Email Verified!"),!0):(l.toast("Not Verified Yet","error"),!1)):!1},logout(){h.logout()},onPlaybackUpdate(e,o,s){!a.local.loaded||!a.room.id||a.local.isProcessingRemote||h.sync({playback:{status:e,time:o,speed:t.video.playbackRate,trigger:a.local.sessionId,timestamp:Date.now(),action:s,senderName:a.user.name,senderUid:a.user.uid}})},onPresenceUpdate(e){if(a.local.loaded){const o=a.room.presence||{};Object.keys(o).forEach(s=>{if(o[s]===!0&&e[s]===!1){const i=a.room.participants[s]?.name||"Someone";s!==a.user.uid&&l.toast(`${i} Disconnected`)}})}a.room.presence=e,u.renderMembers(a.room.participants)},onRemoteUpdate(e){const o=e.participants[a.user.uid];if(o){if(o.kicked){alert("You have been kicked from the room."),location.reload();return}if(o.active?(t.waitingScreen.classList.add("hidden"),t.waitingScreen.classList.remove("flex")):(t.waitingScreen.classList.remove("hidden"),t.waitingScreen.classList.add("flex")),w.isHost()&&!O){const s=Object.entries(e.participants).find(([,i])=>!i.active&&!i.kicked);s&&(O=!0,t.modalTitle.innerText="Join Request",t.modalText.innerText=`${s[1].name} wants to join.`,t.modalConfirm.innerText="Accept",t.modalCancel.innerText="Deny",t.modalConfirm.onclick=()=>{h.acceptUser(s[0]),t.modal.classList.add("hidden"),O=!1},t.modalCancel.onclick=()=>{h.rejectUser(s[0]),t.modal.classList.add("hidden"),O=!1},t.modal.classList.remove("hidden"))}a.room.host=e.host,a.room.participants=e.participants,a.local.hostHash=e.participants[e.host]?.fileHash,u.renderMembers(e.participants),t.headerRoomId&&(t.headerRoomId.innerText="#"+a.room.id),e.name&&t.headerRoomName&&(t.headerRoomName.innerText=l.toTitleCase(e.name))}},onChatUpdate(e){if(e.length===0){t.chatList.innerHTML="",N=0,a.chatLog=[];const s=document.createElement("div");s.className="p-3 text-[14px] max-w-[80%] break-words chat-bubble-ai mb-2",s.innerHTML='<div class="font-bold text-[11px] mb-0.5 text-white/80">Friday</div>Hello! I am Friday, your helpful AI assistant. You can talk to me by using the <span class="cmd-pill">/AI</span> command.',t.chatList.appendChild(s);return}const o=e.filter(s=>s.timestamp>N);if(o.length>0)o.sort((s,i)=>s.timestamp-i.timestamp),o.forEach(s=>{const i=s.uid===a.user.uid,r=document.createElement("div"),c=s.uid==="gemini-ai-bot";c?r.className="p-3 text-[14px] max-w-[80%] break-words chat-bubble-ai mb-2":r.className=i?"p-3 text-[14px] max-w-[80%] break-words chat-bubble-me mb-2":"p-3 text-[14px] max-w-[80%] break-words chat-bubble-other mb-2";let d=l.esc(s.text);d.toLowerCase().startsWith("/ai ")&&(d=`<span class="cmd-pill">/AI</span>${d.substring(4)}`),r.innerHTML=`<div class="font-bold text-[11px] mb-0.5 ${i?"text-blue-200":c?"text-white/80":"text-gray-400"}">${l.esc(s.sender)}</div>${d}`,t.chatList.appendChild(r),i||u.addChatBubble(s),N=Math.max(N,s.timestamp)}),t.chatList.scrollTop=t.chatList.scrollHeight,this.setupLongPressCopy();else if(t.chatList.children.length===0){const s=document.createElement("div");s.className="p-3 text-[14px] max-w-[80%] break-words chat-bubble-ai mb-2",s.innerHTML='<div class="font-bold text-[11px] mb-0.5 text-white/80">Friday</div>Hello! I am Friday, your helpful AI assistant. You can talk to me by using the <span class="cmd-pill">/AI</span> command.',t.chatList.appendChild(s)}a.chatLog=e},onTypingUpdate(e){const o=e.filter(s=>s.uid!==a.user.uid&&Date.now()-s.timestamp<3e3);if(o.length>0){t.typingIndicator.classList.remove("hidden"),t.videoTypingIndicator.classList.remove("hidden");const s=o.map(i=>i.name).join(", ");t.typingIndicator.querySelector("span").innerText=`${s} is typing...`,t.videoTypingIndicator.querySelector("span").innerText=`${s} is typing...`}else t.typingIndicator.classList.add("hidden"),t.videoTypingIndicator.classList.add("hidden")},onCommandUpdate(e,o){!a.local.loaded||o===a.user.name||(l.toast(`${o} triggered global ${e.action}`),this.executeAiCommand(e,!0))},handleInput(e,o){e.style.height="auto";const s=Math.min(e.scrollHeight,120);e.style.height=s+"px";const i=o==="sidebar"?t.quickChatInput:t.chatInput;if(i&&i.innerText!==e.innerText&&(i.innerText=e.innerText),H&&clearTimeout(H),h.setTyping(!0),H=setTimeout(()=>h.setTyping(!1),2e3),this.handleAutocomplete(e,o),o==="quick"&&window.visualViewport){const r=window.visualViewport.height,c=window.innerHeight-r;if(c>0){const d=document.getElementById("quick-chat");d.style.transform=`translateY(-${c}px)`,d.style.bottom="0px"}}},handleAutocomplete(e,o){if(o==="quick")return;const s=e.innerText.trim(),i=o==="sidebar"?document.getElementById("sidebar-autocomplete"):document.getElementById("quick-chat-autocomplete");if(s.startsWith("/")){const r=s.substring(1).toLowerCase(),d=["ai","clear","movie"].filter(g=>g.startsWith(r));d.length>0?(i.innerHTML="",d.forEach(g=>{const f=document.createElement("div");f.className="px-4 py-2 hover:bg-element cursor-pointer text-sm flex items-center gap-2 border-b border-border/50 last:border-0",f.innerHTML=`<span class="cmd-pill">/${g.toUpperCase()}</span>`,f.onclick=()=>{this.completeCommand(e,g,i,o)},i.appendChild(f)}),i.classList.remove("hidden")):i.classList.add("hidden")}else i.classList.add("hidden")},completeCommand(e,o,s,i){e.innerText=`/${o} `,this.handleInput(e,i),s.classList.add("hidden");const r=document.createRange(),c=window.getSelection();r.selectNodeContents(e),r.collapse(!1),c.removeAllRanges(),c.addRange(r),e.focus()},handleInputKeydown(e,o){const s=o==="sidebar"?document.getElementById("sidebar-autocomplete"):document.getElementById("quick-chat-autocomplete");e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),!s.classList.contains("hidden")&&s.children.length===1?s.children[0].click():this.submitChat(o))},handleRemotePlayback(e){if(e.trigger===a.local.sessionId)return;const o=e.senderUid===a.user?.uid,s=(Date.now()-e.timestamp)/1e3,i=e.status==="playing"?e.time+s:e.time;a.local.isProcessingRemote=!0,Math.abs(t.video.currentTime-i)>1.5&&(t.video.currentTime=i),e.status==="playing"&&t.video.paused?t.video.safePlay():e.status==="paused"&&!t.video.paused&&t.video.pause(),!o&&e.senderName&&e.action&&a.playback.lastHandledTrigger!==e.trigger&&(l.toast(`${e.senderName}: ${e.action}`),a.playback.lastHandledTrigger=e.trigger),setTimeout(()=>a.local.isProcessingRemote=!1,500)},async joinRoom(){const e=document.querySelector('button[data-tab="host"]').dataset.active==="true",o=e?l.genId():t.roomCode.value.trim().toUpperCase();if(!o&&!e)return l.toast("Room Code Required","error");const s=e?t.roomCode.value||"Watch Party":null;u.toggleSpinner(!0);try{a.room.id=o,h.joinRoom(o,e,s,i=>this.onRemoteUpdate(i),i=>this.handleRemotePlayback(i),i=>this.onPresenceUpdate(i),i=>this.onChatUpdate(i),i=>this.onTypingUpdate(i),(i,r)=>this.onCommandUpdate(i,r)).then(()=>{t.lobby.classList.add("hidden"),t.room.classList.remove("hidden"),t.room.classList.add("flex"),window.innerWidth>768?a.local.sidebarOpen=!0:a.local.sidebarOpen=!1,u.render("local",a.local),l.toast(e?`Created Room ${o}`:`Joined Room ${o}`)}).catch(()=>{l.toast("Connection Failed","error"),u.toggleSpinner(!1)})}catch(i){l.toast(i.message,"error"),u.toggleSpinner(!1)}},kick(e){if(!w.isHost())return l.toast("Unauthorized Action","error");h.kickUser(e)},setSpeed(e){a.playback.speed=parseFloat(e),t.video.playbackRate=a.playback.speed,document.getElementById("disp-speed").innerText=e+"x",l.toast(`Speed: ${e}x`)},setAspect(e){a.local.aspect=e,a.local={...a.local},document.querySelectorAll(".control-menu").forEach(o=>o.classList.remove("active")),l.toast(`Aspect: ${e}`)},setSubtitleSize(e){a.local.subtitleSize=parseInt(e),a.local={...a.local}},setOrient(e){a.local.orientation=e,screen.orientation&&screen.orientation.lock&&(e==="auto"?screen.orientation.unlock():screen.orientation.lock(e).catch(()=>{console.log("Native orientation lock failed, falling back to CSS")})),a.local={...a.local},e!=="auto"?l.toast(`Locked ${l.toTitleCase(e)}`):l.toast("Orientation: Auto"),document.querySelectorAll(".control-menu").forEach(o=>o.classList.remove("active"))},loadSub(e){if(!e)return;const o=URL.createObjectURL(e),s=document.createElement("track");s.kind="subtitles",s.src=o,s.label=e.name,s.default=!0,Array.from(t.video.textTracks).forEach(i=>i.mode="disabled"),s.track.mode="showing",t.video.appendChild(s),a.local.subtitles.push({label:e.name,track:s.track}),a.local={...a.local},l.toast("Subtitle Loaded")},switchTab(e){document.querySelectorAll("[data-tab]").forEach(o=>o.dataset.active=o.dataset.tab===e),t.roomCode.parentElement.classList.remove("hidden"),e==="host"?(document.getElementById("label-room").innerText="Room Name",t.roomCode.placeholder="Enter Room Name",t.btnEnter.innerText="Create Room"):(document.getElementById("label-room").innerText="Room Code",t.roomCode.placeholder="Enter Room Code",t.btnEnter.innerText="Enter Room")},togglePassword(e,o){const s=document.getElementById(e),i=o.querySelector("i");s.type==="password"?(s.type="text",i.classList.remove("fa-eye"),i.classList.add("fa-eye-slash")):(s.type="password",i.classList.remove("fa-eye-slash"),i.classList.add("fa-eye"))},toggleSidebar(){a.local.sidebarOpen=!a.local.sidebarOpen,a.local={...a.local}},setupKeyboardHandling(){if(document.addEventListener("keydown",e=>{const o=document.activeElement;if(!(o&&(o.isContentEditable||o.tagName==="INPUT"||o.tagName==="TEXTAREA")))switch(e.code){case"Space":case"KeyK":e.preventDefault(),p.actions.play();break;case"ArrowLeft":case"KeyJ":e.preventDefault(),p.actions["seek-back"]();break;case"ArrowRight":case"KeyL":e.preventDefault(),p.actions["seek-fwd"]();break;case"ArrowUp":e.preventDefault(),a.local.volume=Math.min(1,a.local.volume+.1),a.local={...a.local},l.toast(`Volume: ${Math.round(a.local.volume*100)}%`);break;case"ArrowDown":e.preventDefault(),a.local.volume=Math.max(0,a.local.volume-.1),a.local={...a.local},l.toast(`Volume: ${Math.round(a.local.volume*100)}%`);break;case"KeyF":e.preventDefault(),p.actions.fullscreen();break;case"KeyM":e.preventDefault(),a.local.volume>0?(a.local.lastVolume=a.local.volume,a.local.volume=0,l.toast("Muted")):(a.local.volume=a.local.lastVolume||1,l.toast("Unmuted")),a.local={...a.local};break}}),window.visualViewport){const e=()=>{const o=window.visualViewport.height,s=window.innerHeight-o,i=s>100,r=document.getElementById("chat-input-container");r&&(r.style.bottom=i?`${s}px`:"0px");const c=document.getElementById("quick-chat");if(c&&!c.classList.contains("ui-hidden"))if(i){c.style.bottom="0px",c.style.transform=`translateY(-${s}px)`;const d=o-60;c.style.maxHeight=`${d}px`}else c.style.bottom="32px",c.style.transform="translateY(0)",c.style.maxHeight=""};window.visualViewport.addEventListener("resize",e),window.visualViewport.addEventListener("scroll",e)}},setupLongPressCopy(){document.querySelectorAll(".chat-bubble-me, .chat-bubble-other, .chat-bubble-ai").forEach(e=>{e.oncontextmenu=o=>{o.preventDefault(),navigator.clipboard.writeText(e.innerText).then(()=>l.toast("Message Copied"))}})},executeAiCommand(e,o=!1){try{switch(!o&&["brightness","volume","aspect","orient","seek","play","pause","speed","lock","sidebar","subtitle"].includes(e.action)&&h.broadcastCommand(e),e.action){case"play":t.video.paused&&t.video.safePlay();break;case"pause":t.video.paused||t.video.pause();break;case"seek":e.time!==void 0?t.video.currentTime=e.time:e.delta!==void 0&&(t.video.currentTime+=e.delta);break;case"speed":this.setSpeed(e.value);break;case"aspect":this.setAspect(e.value);break;case"orient":this.setOrient(e.value);break;case"sidebar":e.value!==a.local.sidebarOpen&&this.toggleSidebar();break;case"subtitle":e.index===-1?Array.from(t.video.textTracks).forEach(s=>s.mode="disabled"):a.local.subtitles[e.index]&&(Array.from(t.video.textTracks).forEach(s=>s.mode="disabled"),a.local.subtitles[e.index].track.mode="showing",a.local={...a.local});break;case"kick":w.isHost()&&this.kick(e.uid);break;case"lock":a.local.locked!==e.value&&p.actions.lock();break;case"clear":w.isHost()&&h.clearChat();break;case"logout":t.btnLeave.click();break;case"copy":t.btnCopy.click();break;case"volume":a.local.volume=Math.max(0,Math.min(1,e.value)),a.local={...a.local};break;case"brightness":a.local.brightness=Math.max(0,Math.min(1,e.value)),a.local={...a.local};break;case"fullscreen":p.actions.fullscreen();break}}catch(s){console.error("AI Command Error",s)}},submitChat:async e=>{const s=(e==="sidebar"?t.chatInput:t.quickChatInput).innerText.trim();if(!s)return;t.chatInput.innerText="",t.quickChatInput.innerText="",t.chatInput.style.height="auto",t.quickChatInput.style.height="auto",e==="quick"&&t.quickChat&&t.quickChat.classList.add("ui-hidden","pointer-events-none","translate-y-20");const i=s.toLowerCase();if(i==="/clear"){w.isHost()?(await h.clearChat(),l.toast("Chat Cleared")):l.toast("Host Only Command","error");return}if(i==="/movie"){l.toast("Setting up Movie Mode..."),[{action:"volume",value:1},{action:"brightness",value:1},{action:"aspect",value:"Fill"},{action:"orient",value:"landscape"},{action:"seek",time:0},{action:"pause"},{action:"fullscreen"},{action:"speed",value:1}].forEach(c=>k.executeAiCommand(c)),h.clearChat();return}if(await h.sendChat(s),i.startsWith("/ai ")){const r=s.substring(4).trim();if(r){const c=await fe.ask(r),d=c.match(/\|\|\|(.*)\|\|\|/);let g=c;if(d)try{const f=d[1],n=JSON.parse(f);Array.isArray(n)?n.forEach(m=>k.executeAiCommand(m)):k.executeAiCommand(n),g=c.replace(/\|\|\|.*\|\|\|/,"").trim()}catch(f){console.warn("Failed to parse AI command",f)}g&&await h.sendChat(g,"Friday","gemini-ai-bot")}}},setupDOMEvents(){window.onerror=n=>l.toast(`Error: ${n}`,"error"),window.onbeforeunload=n=>{n.preventDefault(),n.returnValue=""},t.signupName?.addEventListener("input",n=>{n.target.value=l.toTitleCase(n.target.value)}),t.loginPass?.addEventListener("keydown",n=>{n.key==="Enter"&&k.handleLogin()}),t.signupConfirm?.addEventListener("keydown",n=>{n.key==="Enter"&&k.handleSignup()}),t.signupName?.addEventListener("keydown",n=>{n.key==="Enter"&&t.signupEmail.focus()}),t.signupEmail?.addEventListener("keydown",n=>{n.key==="Enter"&&t.signupPass.focus()}),t.signupPass?.addEventListener("keydown",n=>{n.key==="Enter"&&t.signupConfirm.focus()}),t.loginEmail?.addEventListener("keydown",n=>{n.key==="Enter"&&t.loginPass.focus()}),t.roomCode?.addEventListener("input",n=>{document.querySelector('button[data-tab="host"]')?.dataset.active==="true"?n.target.value=l.toTitleCase(n.target.value):n.target.value=n.target.value.toUpperCase()}),t.roomCode?.addEventListener("keydown",n=>{n.key==="Enter"&&t.btnEnter.click()}),t.btnVerifyCheck?.addEventListener("click",()=>{h.checkVerification()}),t.btnEnter?.addEventListener("click",()=>this.joinRoom()),t.btnUpload?.addEventListener("click",()=>t.fileVideo.click()),t.btnCopy?.addEventListener("click",()=>{if(a.room.id){const n=document.createElement("textarea");n.value=a.room.id,document.body.appendChild(n),n.select();try{document.execCommand("copy"),l.toast("ID Copied")}catch{l.toast("Copy Failed","error")}document.body.removeChild(n)}}),t.btnLeave?.addEventListener("click",()=>{t.modalTitle.innerText="Leave Room?",t.modalText.innerText="You Will Be Disconnected.",t.modalConfirm.innerText="Leave",t.modalCancel.innerText="Cancel",t.modalConfirm.onclick=async()=>{await h.leaveRoom(),await h.logout()},t.modalCancel.onclick=()=>t.modal.classList.add("hidden"),t.modal.classList.remove("hidden")}),t.fileVideo.onchange=n=>n.target.files[0]&&p.load(n.target.files[0]),t.fileSub.onchange=n=>n.target.files[0]&&this.loadSub(n.target.files[0]),document.getElementById("btn-load-sub")?.addEventListener("click",n=>{n.stopPropagation(),t.fileSub.click()});let e=0,o=0,s=0;const i=300,r=n=>{const m=Date.now();m-s<i?(q&&clearTimeout(q),q=null,n==="left"?p.actions["seek-back"]():n==="right"?p.actions["seek-fwd"]():n==="center"&&p.actions.play()):(n==="center"||n==="left"||n==="right")&&(q=setTimeout(()=>{t.controls.classList.contains("ui-instant-hide")||t.controls.classList.contains("ui-hidden")||t.controls.classList.contains("translate-y-full")?u.showControls():(t.controls.classList.add("ui-instant-hide"),t.btnUnlock.classList.add("ui-instant-hide"),t.quickChat.classList.add("ui-instant-hide"))},i)),s=m},c=(n,m)=>{if(a.local.locked){(n.type==="touchend"||n.type==="mouseup")&&(t.btnUnlock.classList.remove("ui-instant-hide","ui-hidden"),setTimeout(()=>{a.local.locked&&t.btnUnlock.classList.add("ui-instant-hide")},2e3));return}const E=n.type.startsWith("touch");if(n.type==="touchend"||n.type==="mouseup"){E&&(a.local.mouseGestureActive||r(m)),a.local.mouseGestureActive=!1,t.gestureFeedback.style.opacity="0";return}const L=E?n.touches?.[0]?.clientY:n.clientY;if(L!==void 0){if(n.type==="touchstart"||n.type==="mousedown")e=L,o=m==="left"?a.local.brightness:a.local.volume,a.local.mouseGestureActive=!1;else if(n.type==="touchmove"||n.type==="mousemove"&&(n.buttons===1||E)){n.preventDefault();const R=e-L;if(Math.abs(R)>10){a.local.mouseGestureActive=!0,t.gestureFeedback.style.opacity="1";const _=R/window.innerHeight*2,I=Math.max(0,Math.min(1,o+_));m==="left"?(a.local.brightness=I,t.gestureText.innerText=`Brightness: ${Math.round(I*100)}%`,a.local={...a.local}):m==="right"&&(a.local.volume=I,t.gestureText.innerText=`Volume: ${Math.round(I*100)}%`,a.local={...a.local})}}}},d=document.getElementById("zone-left"),g=document.getElementById("zone-right"),f=document.getElementById("zone-center");d&&g&&f&&(["touchstart","touchmove","touchend","mousedown","mousemove","mouseup"].forEach(n=>{d.addEventListener(n,m=>c(m,"left"),{passive:!1}),g.addEventListener(n,m=>c(m,"right"),{passive:!1})}),f.addEventListener("click",()=>{if(a.local.locked){t.btnUnlock.classList.remove("ui-instant-hide","ui-hidden"),setTimeout(()=>{a.local.locked&&t.btnUnlock.classList.add("ui-instant-hide")},2e3);return}r("center")})),t.btnUnlock.onclick=()=>{a.local.locked=!a.local.locked,a.local={...a.local}},t.controls?.addEventListener("click",n=>{const m=n.target.closest("button");m&&m.dataset.action&&p.actions[m.dataset.action]&&!a.local.longPressActive&&p.actions[m.dataset.action](n)}),document.addEventListener("click",n=>{const m=n.target.closest("#quick-chat"),E=n.target.closest('button[data-action="toggle-quick-chat"]');!m&&!E&&(t.quickChat.classList.contains("ui-hidden")||t.quickChat.classList.add("ui-hidden","pointer-events-none","translate-y-20")),!n.target.closest(".control-menu")&&!n.target.closest("button[data-action]")&&!n.target.closest("#menu-sub")&&(document.querySelectorAll(".control-menu").forEach(L=>L.classList.remove("active")),t.menuSub.classList.add("hidden"))})}};k.init();
